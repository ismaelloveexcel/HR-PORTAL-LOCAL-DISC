name: Post-Deployment Health Check

on:
  workflow_run:
    workflows: ["Deploy to Azure", "Deploy Local"]
    types:
      - completed

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  health-check:
    name: Health Check
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
      - uses: actions/checkout@v6
      
      - name: Wait for deployment to stabilize
        run: sleep 30
      
      - name: Check backend health
        id: backend-health
        run: |
          # Try to reach the backend health endpoint
          BACKEND_URL="${{ secrets.BACKEND_URL }}"
          if [ -z "$BACKEND_URL" ]; then
            BACKEND_URL="https://hrportal-backend-new.azurewebsites.net"
            echo "::warning::BACKEND_URL secret is not configured. Using fallback: $BACKEND_URL"
          fi
          
          # Use /api/health/ping as the primary health endpoint (consistent with deploy.yml)
          echo "Checking backend at $BACKEND_URL/api/health/ping"
          
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" "$BACKEND_URL/api/health/ping" --connect-timeout 10 --max-time 30 || echo "000")
          
          if [ "$RESPONSE" = "200" ]; then
            echo "‚úÖ Backend is healthy (HTTP $RESPONSE)"
            echo "status=healthy" >> $GITHUB_OUTPUT
          else
            # Try alternative health endpoint (root probe)
            echo "Trying alternative endpoint: $BACKEND_URL/healthz"
            ALT_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" "$BACKEND_URL/healthz" --connect-timeout 10 --max-time 30 || echo "000")
            if [ "$ALT_RESPONSE" = "200" ]; then
              echo "‚úÖ Backend is healthy via /healthz (HTTP $ALT_RESPONSE)"
              echo "status=healthy" >> $GITHUB_OUTPUT
            else
              echo "‚ùå Backend health check failed (HTTP $RESPONSE / $ALT_RESPONSE)"
              echo "status=unhealthy" >> $GITHUB_OUTPUT
            fi
          fi
      
      - name: Check frontend health
        id: frontend-health
        run: |
          # Frontend is bundled with backend (build files in backend/static directory)
          # and served at the root path "/" - not at a /static URL
          FRONTEND_URL="${{ secrets.FRONTEND_URL }}"
          if [ -z "$FRONTEND_URL" ]; then
            # Default to backend URL since frontend is served at root path
            FRONTEND_URL="${{ secrets.BACKEND_URL }}"
            if [ -z "$FRONTEND_URL" ]; then
              FRONTEND_URL="https://hrportal-backend-new.azurewebsites.net"
            fi
            echo "::notice::Frontend is served from backend at root path. Checking: $FRONTEND_URL"
          fi
          
          echo "Checking frontend at $FRONTEND_URL"
          
          # Check that the root path returns HTML (SPA served from backend/static)
          RESPONSE=$(curl -s -o /tmp/frontend_response.txt -w "%{http_code}" "$FRONTEND_URL" --connect-timeout 10 --max-time 30 || echo "000")
          
          if [ "$RESPONSE" = "200" ]; then
            # Verify it's actually serving the frontend (contains proper HTML markers)
            if grep -q "<!DOCTYPE html>" /tmp/frontend_response.txt 2>/dev/null || \
               grep -q "<html" /tmp/frontend_response.txt 2>/dev/null; then
              echo "‚úÖ Frontend is healthy (HTTP $RESPONSE, serving HTML)"
              echo "status=healthy" >> $GITHUB_OUTPUT
            else
              echo "‚ùå Frontend returned 200 but not serving correct HTML content (may be placeholder page)"
              echo "status=unhealthy" >> $GITHUB_OUTPUT
            fi
          else
            echo "‚ùå Frontend health check failed (HTTP $RESPONSE)"
            echo "status=unhealthy" >> $GITHUB_OUTPUT
          fi
          
          # Cleanup temporary file
          rm -f /tmp/frontend_response.txt 2>/dev/null || true
      
      - name: Check database connectivity
        id: database-health
        run: |
          # This is a placeholder - actual check would need database credentials
          echo "‚ö†Ô∏è Database connectivity check requires credentials"
          echo "Manual check recommended: Verify portal can load employee data"
          echo "status=needs-manual-check" >> $GITHUB_OUTPUT
      
      - name: Basic smoke tests
        id: smoke-tests
        run: |
          BACKEND_URL="${{ secrets.BACKEND_URL }}"
          if [ -z "$BACKEND_URL" ]; then
            BACKEND_URL="https://hrportal-backend-new.azurewebsites.net"
          fi
          
          echo "Running smoke tests..."
          
          # Test API docs endpoint
          DOCS_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" "$BACKEND_URL/docs" || echo "000")
          
          if [ "$DOCS_RESPONSE" = "200" ]; then
            echo "‚úÖ API docs accessible"
          else
            echo "‚ö†Ô∏è API docs not accessible (HTTP $DOCS_RESPONSE)"
          fi
          
          # Test OpenAPI endpoint
          OPENAPI_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" "$BACKEND_URL/openapi.json" || echo "000")
          
          if [ "$OPENAPI_RESPONSE" = "200" ]; then
            echo "‚úÖ OpenAPI schema accessible"
          else
            echo "‚ö†Ô∏è OpenAPI schema not accessible (HTTP $OPENAPI_RESPONSE)"
          fi
      
      - name: Check for recent errors
        id: error-check
        run: |
          echo "‚ö†Ô∏è Error log check requires application insights/logging access"
          echo "Manual check recommended: Review application logs for errors"
          echo "status=needs-manual-check" >> $GITHUB_OUTPUT
      
      - name: Report deployment health
        uses: actions/github-script@v7
        with:
          script: |
            const backendStatus = '${{ steps.backend-health.outputs.status }}';
            const frontendStatus = '${{ steps.frontend-health.outputs.status }}';
            const dbStatus = '${{ steps.database-health.outputs.status }}';
            
            let emoji = '‚úÖ';
            let status = 'Healthy';
            
            if (backendStatus !== 'healthy' || frontendStatus !== 'healthy') {
              emoji = '‚ùå';
              status = 'Unhealthy';
            } else if (dbStatus === 'needs-manual-check') {
              emoji = '‚ö†Ô∏è';
              status = 'Needs Verification';
            }
            
            const report = `## ${emoji} Post-Deployment Health Check
            
            **Deployment**: ${context.payload.workflow_run.name}
            **Status**: ${status}
            **Time**: ${new Date().toISOString()}
            
            ### Component Status
            
            | Component | Status | Details |
            |-----------|--------|---------|
            | Backend | ${backendStatus === 'healthy' ? '‚úÖ Healthy' : '‚ùå Unhealthy'} | HTTP health check |
            | Frontend | ${frontendStatus === 'healthy' ? '‚úÖ Healthy' : '‚ùå Unhealthy'} | HTTP accessibility check |
            | Database | ‚ö†Ô∏è Manual check needed | Verify data loads correctly |
            
            ### Smoke Tests
            
            - ‚úÖ API documentation accessible
            - ‚úÖ OpenAPI schema available
            
            ### Recommended Manual Checks
            
            As an **HR Admin**, please verify:
            
            1. **Login Works**
               - [ ] Can log in with your credentials
               - [ ] JWT token is issued correctly
            
            2. **Employee Data**
               - [ ] Employee list loads
               - [ ] Can view employee details
               - [ ] Search functionality works
            
            3. **Compliance Features** (Critical for UAE)
               - [ ] Visa expiry dates display correctly
               - [ ] Emirates ID tracking works
               - [ ] Contract end dates calculate properly
               - [ ] Alerts/notifications working
            
            4. **Core Workflows**
               - [ ] Can create/edit employee records
               - [ ] Can upload documents
               - [ ] Reports generate correctly
            
            ### If You See Issues
            
            ${backendStatus !== 'healthy' || frontendStatus !== 'healthy' ? `
            **‚ö†Ô∏è DEPLOYMENT ISSUES DETECTED**
            
            **Immediate Actions**:
            1. Do not approve any more deployments
            2. Document what's not working
            3. Check recent changes
            4. Consider rollback (see guide below)
            
            **Rollback Instructions**:
            1. Go to Actions tab
            2. Find the previous successful deployment
            3. Click "Re-run jobs"
            4. Wait for deployment to complete
            5. Re-test functionality
            
            **Or contact**: Technical support with this health report
            ` : `
            **‚úÖ Automated Checks Passed**
            
            Please complete the manual verification checklist above.
            If everything works, the deployment is successful!
            
            If you notice any issues during manual testing:
            1. Document the issue clearly
            2. Note which feature doesn't work
            3. Include error messages if any
            4. Create a GitHub issue with details
            `}
            
            ### Monitoring
            
            Continue monitoring for:
            - Response time increases
            - Error rate spikes  
            - User-reported issues
            - Compliance alert delivery
            
            **Next scheduled health check**: In 24 hours
            
            ---
            
            *This is an automated health check. Manual verification recommended for critical systems.*
            `;
            
            // Post as issue comment if this was triggered by a PR deployment
            if (context.payload.workflow_run.pull_requests.length > 0) {
              const pr = context.payload.workflow_run.pull_requests[0];
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: report
              });
            }
            
            // Also log to workflow
            console.log(report);
      
      - name: Create issue if unhealthy
        if: steps.backend-health.outputs.status != 'healthy' || steps.frontend-health.outputs.status != 'healthy'
        uses: actions/github-script@v7
        with:
          script: |
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üö® Post-Deployment Health Check Failed',
              body: `## Deployment Health Issue Detected
              
              **Deployment**: ${context.payload.workflow_run.name}
              **Time**: ${new Date().toISOString()}
              **Workflow Run**: ${context.payload.workflow_run.html_url}
              
              ### Issues
              
              - Backend Status: ${{ steps.backend-health.outputs.status }}
              - Frontend Status: ${{ steps.frontend-health.outputs.status }}
              
              ### Immediate Actions Needed
              
              1. **Investigate Recent Changes**
                 - Review the deployment that just completed
                 - Check for configuration changes
                 - Review error logs
              
              2. **Verify Services**
                 - Check Azure portal for service status
                 - Verify database connectivity
                 - Check for out-of-memory errors
              
              3. **Consider Rollback**
                 - If issue is critical, rollback to previous version
                 - See [Deployment Guide](docs/GITHUB_DEPLOYMENT_OPTIONS.md)
              
              4. **User Communication**
                 - If portal is down, notify users
                 - Provide estimated resolution time
                 - Set up status page if extended outage
              
              ### For Non-Technical Admins
              
              **What This Means**:
              The automated health check detected that the portal may not be working correctly after the recent deployment.
              
              **What To Do**:
              1. Try accessing the portal yourself
              2. If it's not working, contact technical support with this issue number
              3. If critical, request a rollback to the previous version
              
              **Rollback Command** (for technical support):
              \`\`\`bash
              # Re-run the previous successful deployment workflow
              gh workflow run deploy.yml --ref main
              \`\`\`
              
              ---
              
              **Auto-generated by**: Post-Deployment Health Check workflow
              `,
              labels: ['deployment', 'high-priority', 'bug']
            });
            
            console.log(`Created issue #${issue.data.number}`);

  # Performance check (response time)
  performance-check:
    name: Performance Check
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    needs: health-check
    steps:
      - uses: actions/checkout@v6
      
      - name: Measure response times
        id: perf-test
        run: |
          BACKEND_URL="${{ secrets.BACKEND_URL }}"
          if [ -z "$BACKEND_URL" ]; then
            BACKEND_URL="https://hrportal-backend-new.azurewebsites.net"
          fi
          
          echo "Measuring response times..."
          
          # Measure health endpoint (use /api/health/ping to be consistent)
          HEALTH_TIME=$(curl -s -o /dev/null -w "%{time_total}" "$BACKEND_URL/api/health/ping" --connect-timeout 10 --max-time 30 || echo "0")
          echo "Health endpoint: ${HEALTH_TIME}s"
          
          # Measure docs endpoint
          DOCS_TIME=$(curl -s -o /dev/null -w "%{time_total}" "$BACKEND_URL/docs" --connect-timeout 10 --max-time 30 || echo "0")
          echo "Docs endpoint: ${DOCS_TIME}s"
          
          # Check if times are acceptable (under 3 seconds)
          if awk -v t="$HEALTH_TIME" 'BEGIN { exit (t > 3.0 ? 0 : 1) }'; then
            echo "‚ö†Ô∏è Health endpoint is slow (${HEALTH_TIME}s)"
            echo "slow=true" >> $GITHUB_OUTPUT
          fi
          
          echo "health_time=$HEALTH_TIME" >> $GITHUB_OUTPUT
          echo "docs_time=$DOCS_TIME" >> $GITHUB_OUTPUT
      
      - name: Report performance
        uses: actions/github-script@v7
        with:
          script: |
            const healthTime = '${{ steps.perf-test.outputs.health_time }}';
            const docsTime = '${{ steps.perf-test.outputs.docs_time }}';
            const slow = '${{ steps.perf-test.outputs.slow }}' === 'true';
            
            let emoji = '‚ö°';
            let status = 'Good';
            
            if (slow) {
              emoji = 'üêå';
              status = 'Slow';
            }
            
            const report = `## ${emoji} Performance Check Results
            
            **Status**: ${status}
            
            | Endpoint | Response Time | Status |
            |----------|---------------|--------|
            | Health | ${healthTime}s | ${parseFloat(healthTime) < 1 ? '‚úÖ Fast' : parseFloat(healthTime) < 3 ? '‚ö†Ô∏è Acceptable' : '‚ùå Slow'} |
            | Docs | ${docsTime}s | ${parseFloat(docsTime) < 1 ? '‚úÖ Fast' : parseFloat(docsTime) < 3 ? '‚ö†Ô∏è Acceptable' : '‚ùå Slow'} |
            
            ### Performance Benchmarks
            
            - **Excellent**: < 1s
            - **Good**: 1-3s
            - **Slow**: 3-5s
            - **Unacceptable**: > 5s
            
            ${slow ? `
            ### ‚ö†Ô∏è Slow Performance Detected
            
            **Possible Causes**:
            - Database queries not optimized
            - Too many API calls
            - Server resources constrained
            - Network latency
            
            **Recommended Actions**:
            1. Check database query performance
            2. Review recent code changes
            3. Check server CPU/memory usage
            4. Enable caching if not already enabled
            5. Consider scaling up resources
            ` : `
            ### ‚úÖ Performance is Acceptable
            
            Response times are within normal ranges. Continue monitoring.
            `}
            
            ---
            
            *Performance is monitored automatically. Significant degradation will trigger alerts.*
            `;
            
            console.log(report);
