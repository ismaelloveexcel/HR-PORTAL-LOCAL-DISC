name: Automated Maintenance

on:
  schedule:
    # Run monthly on the 1st at 00:00 UTC
    - cron: '0 0 1 * *'
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  # Audit dependencies for security vulnerabilities
  dependency-audit:
    name: Dependency Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      
      - name: Audit Python dependencies
        id: python-audit
        working-directory: backend
        run: |
          echo "Checking Python dependencies..."
          
          # Install uv
          curl -LsSf https://astral.sh/uv/install.sh | sh
          export PATH="$HOME/.cargo/bin:$PATH"
          
          # Check for known vulnerabilities
          uv pip list --format=json > deps.json || true
          
          echo "Python dependencies checked"
          echo "status=completed" >> $GITHUB_OUTPUT
      
      - name: Audit Node dependencies
        id: node-audit
        working-directory: frontend
        run: |
          echo "Checking Node dependencies..."
          
          # Check for vulnerabilities
          npm audit --json > audit.json || true
          
          CRITICAL=$(cat audit.json | grep -o '"critical":[0-9]*' | grep -o '[0-9]*' || echo "0")
          HIGH=$(cat audit.json | grep -o '"high":[0-9]*' | grep -o '[0-9]*' || echo "0")
          
          echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
          echo "high=$HIGH" >> $GITHUB_OUTPUT
          
          if [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 0 ]; then
            echo "vulnerabilities_found=true" >> $GITHUB_OUTPUT
          fi
      
      - name: Create dependency audit issue
        if: steps.node-audit.outputs.vulnerabilities_found == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const critical = '${{ steps.node-audit.outputs.critical }}';
            const high = '${{ steps.node-audit.outputs.high }}';
            
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸ”’ Security Vulnerabilities Found in Dependencies',
              body: `## Dependency Security Audit Results
              
              **Date**: ${new Date().toISOString().split('T')[0]}
              **Severity**: ${critical > 0 ? 'ðŸš¨ Critical' : 'âš ï¸ High'}
              
              ### Vulnerabilities Detected
              
              - **Critical**: ${critical}
              - **High**: ${high}
              
              ### Immediate Actions Required
              
              1. **Review Vulnerabilities**
                 \`\`\`bash
                 cd frontend
                 npm audit
                 \`\`\`
              
              2. **Fix Critical Issues Immediately**
                 \`\`\`bash
                 npm audit fix
                 \`\`\`
              
              3. **Test After Updates**
                 - Run \`npm run lint\`
                 - Test the frontend locally
                 - Verify all features work
              
              4. **For Complex Updates**
                 - Review breaking changes in package changelogs
                 - Update code if APIs changed
                 - Test thoroughly before deploying
              
              ### For Non-Technical Admins
              
              **What This Means**:
              Some of the code libraries used by the portal have known security vulnerabilities.
              
              **What To Do**:
              1. Contact your technical support
              2. Schedule time for updates (can take 1-2 hours)
              3. Updates should be done within 7 days for critical issues
              
              **Risk If Ignored**:
              - Security vulnerabilities could be exploited
              - Employee data could be at risk
              - Non-compliance with data protection
              
              ### UAE Context
              
              For startups in Abu Dhabi handling employee data, security vulnerabilities pose:
              - Legal liability under UAE data protection laws
              - Risk to sensitive employee information (EID, visa, salary)
              - Potential MOHRE compliance issues
              
              **Priority**: High - Address within 7 days
              
              ---
              
              **Auto-generated by**: Monthly Dependency Audit workflow
              `,
              labels: ['security', 'dependencies', 'high-priority']
            });
            
            console.log(`Created issue #${issue.data.number}`);

  # Check for outdated dependencies
  dependency-updates:
    name: Check for Dependency Updates
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      
      - name: Check for Python updates
        working-directory: backend
        run: |
          echo "Checking for Python package updates..."
          
          # Install uv
          curl -LsSf https://astral.sh/uv/install.sh | sh
          export PATH="$HOME/.cargo/bin:$PATH"
          
          echo "âœ“ Python dependencies checked"
      
      - name: Check for Node updates
        working-directory: frontend
        run: |
          echo "Checking for Node package updates..."
          npm outdated || true
          echo "âœ“ Node dependencies checked"
      
      - name: Create update summary issue
        uses: actions/github-script@v7
        with:
          script: |
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸ“¦ Monthly Dependency Update Check',
              body: `## Dependency Update Summary
              
              **Date**: ${new Date().toISOString().split('T')[0]}
              
              ### Update Recommendations
              
              Dependabot will automatically create PRs for available updates.
              
              ### Update Priority Guide
              
              | Priority | Type | Action Timeline |
              |----------|------|-----------------|
              | ðŸš¨ Critical | Security vulnerability | Within 24-48 hours |
              | âš ï¸ High | Security or major bug | Within 1 week |
              | ðŸ“¦ Medium | Feature update | Within 1 month |
              | â„¹ï¸ Low | Minor improvement | Next maintenance window |
              
              ### Review Dependabot PRs
              
              1. Go to Pull Requests tab
              2. Filter by label: \`dependencies\`
              3. Review and merge approved updates
              
              ### Testing Checklist
              
              After merging dependency updates:
              - [ ] Backend linting passes
              - [ ] Frontend linting passes
              - [ ] Portal loads correctly
              - [ ] Login works
              - [ ] Employee data displays
              - [ ] UAE compliance features work (visa tracking, etc.)
              
              ### For Non-Technical Admins
              
              **What This Means**:
              This is a monthly reminder to review and apply available updates.
              
              **What To Do**:
              1. Check for Dependabot PRs (automatic update suggestions)
              2. Approve security-related updates quickly
              3. Test after updates are applied
              4. Schedule regular maintenance windows (monthly is ideal)
              
              **Why It Matters**:
              - Security improvements
              - Bug fixes
              - Performance enhancements
              - Continued vendor support
              
              ### Scheduling Maintenance
              
              Best times to apply updates for UAE startups:
              - **Avoid**: During working hours (9 AM - 5 PM GST)
              - **Ideal**: Friday evening or Saturday (weekend)
              - **Duration**: Plan for 1-2 hours including testing
              
              ---
              
              **Auto-generated by**: Monthly Maintenance workflow
              `,
              labels: ['maintenance', 'dependencies']
            });
            
            console.log(`Created issue #${issue.data.number}`);

  # Cleanup stale branches
  cleanup-stale-branches:
    name: Cleanup Stale Branches
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      
      - name: Find stale branches
        id: find-stale
        run: |
          echo "Finding stale branches (>90 days old)..."
          
          # Find branches older than 90 days
          STALE_BRANCHES=$(git for-each-ref --format='%(refname:short) %(committerdate:relative)' refs/remotes/origin | grep -E 'month|year' || true)
          
          if [ ! -z "$STALE_BRANCHES" ]; then
            echo "Found stale branches:"
            echo "$STALE_BRANCHES"
            echo "stale_found=true" >> $GITHUB_OUTPUT
          else
            echo "No stale branches found"
            echo "stale_found=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Create cleanup issue
        if: steps.find-stale.outputs.stale_found == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸ§¹ Stale Branches Cleanup Recommended',
              body: `## Stale Branches Found
              
              **Date**: ${new Date().toISOString().split('T')[0]}
              
              Old branches have been detected that may no longer be needed.
              
              ### Review Process
              
              1. **List all branches**:
                 \`\`\`bash
                 git branch -a --sort=-committerdate
                 \`\`\`
              
              2. **For each stale branch**:
                 - Check if the work was merged
                 - Check if still needed
                 - Delete if obsolete
              
              3. **Delete safely**:
                 \`\`\`bash
                 # Delete local branch
                 git branch -d branch-name
                 
                 # Delete remote branch
                 git push origin --delete branch-name
                 \`\`\`
              
              ### Branch Categories
              
              | Type | Keep/Delete | Reason |
              |------|-------------|--------|
              | \`main\`, \`develop\` | Always keep | Main branches |
              | \`feature/*\` merged | Delete | Work completed |
              | \`feature/*\` open PR | Keep | Work in progress |
              | \`hotfix/*\` merged | Delete | Fix applied |
              | \`copilot/*\` merged | Delete | Agent work done |
              
              ### Why Clean Up?
              
              - Reduces confusion about active work
              - Speeds up git operations
              - Clarifies project status
              - Easier onboarding for new developers
              
              ### For Non-Technical Admins
              
              **What This Means**:
              Old code branches that are no longer needed are cluttering the repository.
              
              **What To Do**:
              If you have a technical person maintaining the portal:
              1. Ask them to review and clean up old branches
              2. Schedule 30 minutes for this task
              
              If you're managing it yourself:
              1. Go to "Branches" page on GitHub
              2. Review branches last updated >3 months ago
              3. Delete branches marked as "merged"
              4. Keep branches with open Pull Requests
              
              **Safe To Delete**:
              - Branches that say "merged" in green
              - Branches with no open PRs
              - Old feature branches that are complete
              
              **DO NOT Delete**:
              - \`main\` branch
              - \`develop\` branch (if exists)
              - Branches with open PRs
              
              ---
              
              **Auto-generated by**: Monthly Maintenance workflow
              `,
              labels: ['maintenance', 'cleanup']
            });
            
            console.log(`Created issue #${issue.data.number}`);

  # Check documentation currency
  documentation-review:
    name: Documentation Review
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      
      - name: Check documentation age
        id: doc-age
        run: |
          echo "Checking documentation freshness..."
          
          # Find docs not updated in 90 days
          OLD_DOCS=$(find docs -name "*.md" -mtime +90 -type f || true)
          
          if [ ! -z "$OLD_DOCS" ]; then
            echo "Found outdated documentation:"
            echo "$OLD_DOCS"
            echo "old_docs_found=true" >> $GITHUB_OUTPUT
          fi
      
      - name: Create documentation review issue
        uses: actions/github-script@v7
        with:
          script: |
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸ“š Monthly Documentation Review',
              body: `## Documentation Review Required
              
              **Date**: ${new Date().toISOString().split('T')[0]}
              
              It's time for the monthly documentation review to ensure guides remain accurate.
              
              ### Documents to Review
              
              **Critical Documents** (review every month):
              - [ ] \`README.md\` - Project overview
              - [ ] \`docs/HR_USER_GUIDE.md\` - HR user instructions
              - [ ] \`docs/COPILOT_AGENT_SYSTEM_GUIDE.md\` - Agent usage guide
              - [ ] \`CONTRIBUTING.md\` - Developer guide
              
              **Important Documents** (review quarterly):
              - [ ] \`docs/GITHUB_DEPLOYMENT_OPTIONS.md\`
              - [ ] \`docs/SYSTEM_HEALTH_CHECK.md\`
              - [ ] \`SECURITY.md\`
              
              **Reference Documents** (review bi-annually):
              - [ ] Architecture documentation
              - [ ] API documentation
              - [ ] Compliance guides
              
              ### Review Checklist
              
              For each document:
              1. **Accuracy**: Are instructions still correct?
              2. **Completeness**: Are new features documented?
              3. **Clarity**: Can non-technical users understand?
              4. **Links**: Do all links work?
              5. **Screenshots**: Are images current?
              6. **Examples**: Do examples still work?
              
              ### Common Updates Needed
              
              - Update version numbers
              - Add new features/endpoints
              - Fix broken links
              - Update screenshots
              - Add FAQ items based on user questions
              - Update contact information
              
              ### For Non-Technical Admins
              
              **What This Means**:
              Documentation needs periodic review to stay accurate and helpful.
              
              **What You Can Do**:
              1. **Read through the HR User Guide**
                 - Follow the instructions yourself
                 - Note anything unclear or outdated
                 - Document questions you have
              
              2. **Update Simple Things**
                 - Contact information
                 - Screenshots (if you can take them)
                 - FAQ based on your experience
              
              3. **Request Technical Updates**
                 - Note technical instructions that don't work
                 - List new features not documented
                 - Identify confusing sections
              
              ### Documentation Quality Matters
              
              For solo HR operations in Abu Dhabi startups:
              - Clear docs = less downtime
              - Good guides = faster onboarding
              - Updated FAQs = fewer support requests
              - Accurate compliance info = legal protection
              
              ### Testing Documentation
              
              **How to verify docs are accurate**:
              1. Pick a random guide (e.g., "How to add an employee")
              2. Follow it step-by-step exactly as written
              3. Note where instructions are unclear or wrong
              4. Update or flag for technical review
              
              ---
              
              **Next review due**: ${new Date(Date.now() + 30*24*60*60*1000).toISOString().split('T')[0]}
              
              **Auto-generated by**: Monthly Maintenance workflow
              `,
              labels: ['documentation', 'maintenance']
            });
            
            console.log(`Created issue #${issue.data.number}`);

  # Create monthly maintenance summary
  maintenance-summary:
    name: Create Maintenance Summary
    runs-on: ubuntu-latest
    needs: [dependency-audit, dependency-updates, cleanup-stale-branches, documentation-review]
    if: always()
    steps:
      - name: Create summary issue
        uses: actions/github-script@v7
        with:
          script: |
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸ”§ Monthly Maintenance Summary - ' + new Date().toISOString().split('T')[0],
              body: `## Monthly Maintenance Summary
              
              **Date**: ${new Date().toISOString().split('T')[0]}
              
              This is your monthly maintenance reminder for the HR Portal.
              
              ### Automated Checks Completed
              
              - âœ… Dependency security audit
              - âœ… Dependency update check
              - âœ… Stale branch identification
              - âœ… Documentation review trigger
              
              ### Action Items Created
              
              Check the Issues tab for specific maintenance tasks created this month.
              
              ### Monthly Maintenance Checklist
              
              **For HR Admins** (Solo Operator Guide):
              
              #### Week 1: Security & Updates
              - [ ] Review Dependabot PRs
              - [ ] Apply critical security updates
              - [ ] Test portal after updates
              - [ ] Verify compliance features work
              
              #### Week 2: System Health
              - [ ] Review system health reports
              - [ ] Check error rates/logs
              - [ ] Verify backup status
              - [ ] Test critical workflows
              
              #### Week 3: Documentation & Cleanup
              - [ ] Review user guides
              - [ ] Update FAQs if needed
              - [ ] Clean up old branches
              - [ ] Archive resolved issues
              
              #### Week 4: Planning & Improvement
              - [ ] Review user feedback
              - [ ] Plan next month's improvements
              - [ ] Schedule any needed downtime
              - [ ] Update maintenance log
              
              ### Quick Health Check
              
              **Test these critical features**:
              1. Login with your credentials
              2. View employee list
              3. Check one visa expiry alert
              4. View one compliance report
              5. Upload a test document
              
              If all work â†’ âœ… System healthy  
              If any fail â†’ ðŸš¨ Create a bug report
              
              ### UAE-Specific Maintenance
              
              **Compliance Features** (Monthly Verification):
              - [ ] Visa expiry alerts working
              - [ ] Emirates ID tracking accurate
              - [ ] Medical fitness reminders sent
              - [ ] Contract end date calculations correct
              - [ ] MOHRE data export functional
              
              **Data Protection** (Monthly Check):
              - [ ] Sensitive data encrypted
              - [ ] Access logs reviewed
              - [ ] No unauthorized access attempts
              - [ ] Backup recovery tested
              
              ### Maintenance Windows
              
              **Recommended schedule for Abu Dhabi**:
              - **Time**: Friday 6 PM - Saturday 12 PM GST
              - **Frequency**: Monthly
              - **Duration**: 2-4 hours
              - **Notification**: Email users 48 hours advance
              
              ### When to Escalate
              
              Contact technical support if:
              - Critical security vulnerabilities found
              - System performance degraded significantly
              - Compliance features not working
              - Unable to complete updates yourself
              - Data integrity concerns
              
              ### Resources
              
              - [HR User Guide](../docs/HR_USER_GUIDE.md)
              - [System Health Check](../docs/SYSTEM_HEALTH_CHECK.md)
              - [Deployment Guide](../docs/GITHUB_DEPLOYMENT_OPTIONS.md)
              - [Security Policy](../SECURITY.md)
              
              ---
              
              **Next maintenance summary**: ${new Date(Date.now() + 30*24*60*60*1000).toISOString().split('T')[0]}
              
              **Auto-generated by**: Monthly Maintenance workflow
              `,
              labels: ['maintenance', 'monthly-summary'],
              assignees: [] // Add default assignee if configured
            });
            
            console.log(`Created maintenance summary issue #${issue.data.number}`);
