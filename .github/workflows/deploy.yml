name: Deploy to Azure

on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: production-deployment
  cancel-in-progress: false

permissions:
  id-token: write
  contents: read

jobs:
  build-and-deploy:
    name: Build and Deploy HR Portal
    runs-on: ubuntu-latest
    env:
      RESOURCE_GROUP: baynunah-hr-portal-rg
      WEBAPP_NAME: hrportal-backend-new
      STAGING_SLOT: staging
      WEBAPP_URL: https://hrportal-backend-new.azurewebsites.net
      STAGING_WEBAPP_URL: https://hrportal-backend-new-staging.azurewebsites.net

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate required secrets
        run: |
          set -euo pipefail
          echo "üîç Validating required secrets..."
          if [ -z "${{ secrets.AZURE_CLIENT_ID }}" ] || \
             [ -z "${{ secrets.AZURE_TENANT_ID }}" ] || \
             [ -z "${{ secrets.AZURE_SUBSCRIPTION_ID }}" ]; then
            echo "‚ùå ERROR: Azure OIDC secrets missing"
            exit 1
          fi
          if [ -z "${{ secrets.DATABASE_URL }}" ]; then
            echo "‚ùå ERROR: DATABASE_URL secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.AUTH_SECRET_KEY }}" ]; then
            echo "‚ùå ERROR: AUTH_SECRET_KEY secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.ADMIN_EMPLOYEE_ID }}" ] || [ -z "${{ secrets.ADMIN_PASSWORD }}" ]; then
            echo "‚ùå ERROR: ADMIN_EMPLOYEE_ID and ADMIN_PASSWORD secrets are required for automated verification"
            exit 1
          fi
          echo "‚úÖ All required secrets present"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install and build frontend
        working-directory: frontend
        env:
          VITE_API_BASE_URL: /api
        run: |
          set -euo pipefail
          npm ci
          npm run build

      - name: Copy frontend build to backend/static
        run: |
          set -euo pipefail
          rm -rf backend/static
          mkdir -p backend/static
          cp -R frontend/dist/. backend/static/
          echo "‚úÖ Frontend build copied to backend/static"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Create deployment package
        run: |
          set -euo pipefail
          cd backend

          echo "‚ÑπÔ∏è Generating build info"
          BUILD_TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          cat > build_info.txt <<EOF
GIT_COMMIT_SHA=${{ github.sha }}
BUILD_TIMESTAMP=$BUILD_TIMESTAMP
GITHUB_RUN_ID=${{ github.run_id }}
GITHUB_RUN_NUMBER=${{ github.run_number }}
DEPLOYED_BY=${{ github.actor }}
EOF

          find . -name "__pycache__" -type d -prune -exec rm -rf {} +
          rm -f ../deploy.zip
          zip -r ../deploy.zip . -x "*.pyc" "*.pyo" "*.pyd" "__pycache__/*" "tests/*"
          echo "‚úÖ Deployment artifact created at $(pwd)/../deploy.zip"

          cd ..

      - name: Azure login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Ensure staging slot exists
        run: |
          set -euo pipefail
          echo "üîß Ensuring staging slot '${STAGING_SLOT}' exists..."
          SLOT_COUNT=$(az webapp deployment slot list \
            --name "$WEBAPP_NAME" \
            --resource-group "$RESOURCE_GROUP" \
            --query "[?name=='$STAGING_SLOT'] | length(@)" -o tsv || echo "0")

          if [ "$SLOT_COUNT" = "0" ]; then
            echo "Creating staging slot..."
            az webapp deployment slot create \
              --name "$WEBAPP_NAME" \
              --resource-group "$RESOURCE_GROUP" \
              --slot "$STAGING_SLOT" \
              --configuration-source "$WEBAPP_NAME"
            echo "‚úÖ Staging slot created"
          else
            echo "‚úÖ Staging slot already exists"
          fi

          echo "üìã Current deployment slots:"
          az webapp deployment slot list \
            --name "$WEBAPP_NAME" \
            --resource-group "$RESOURCE_GROUP" -o table

      - name: Configure app settings (production & staging)
        run: |
          set -euo pipefail
          ALLOWED_ORIGINS="${{ secrets.ALLOWED_ORIGINS }}"
          if [ -z "$ALLOWED_ORIGINS" ]; then
            ALLOWED_ORIGINS="$WEBAPP_URL"
          fi

          configure_settings() {
            local TARGET_SLOT=$1
            local SLOT_FLAG=""
            if [ "$TARGET_SLOT" != "production" ]; then
              SLOT_FLAG="--slot $TARGET_SLOT"
            fi

            echo "‚öôÔ∏è Configuring app settings for $TARGET_SLOT..."
            az webapp config appsettings set \
              --name "$WEBAPP_NAME" \
              --resource-group "$RESOURCE_GROUP" \
              $SLOT_FLAG \
              --settings \
                DATABASE_URL="${{ secrets.DATABASE_URL }}" \
                AUTH_SECRET_KEY="${{ secrets.AUTH_SECRET_KEY }}" \
                ALLOWED_ORIGINS="$ALLOWED_ORIGINS" \
                APP_ENV="production" \
                GIT_COMMIT_SHA="${{ github.sha }}" \
                BUILD_TIMESTAMP="$(date -u +"%Y-%m-%d %H:%M:%S UTC")" \
                APP_VERSION="${{ github.run_number }}" \
                SCM_DO_BUILD_DURING_DEPLOYMENT="false" \
                ENABLE_ORYX_BUILD="true" \
                WEBSITE_RUN_FROM_PACKAGE="0" \
              --output none
          }

          configure_settings "production"
          configure_settings "$STAGING_SLOT"

          for SLOT in production "$STAGING_SLOT"; do
            SLOT_FLAG=""
            if [ "$SLOT" != "production" ]; then
              SLOT_FLAG="--slot $SLOT"
            fi
            az webapp config set \
              --name "$WEBAPP_NAME" \
              --resource-group "$RESOURCE_GROUP" \
              $SLOT_FLAG \
              --startup-file "./azure_startup.sh" \
              --output none
          done

          echo "‚è≥ Waiting 60 seconds for configuration to propagate..."
          sleep 60

      - name: Deploy package to staging slot
        run: |
          set -euo pipefail
          echo "üöÄ Deploying package to staging slot"
          az webapp deploy \
            --name "$WEBAPP_NAME" \
            --resource-group "$RESOURCE_GROUP" \
            --src-path deploy.zip \
            --type zip \
            --slot "$STAGING_SLOT" \
            --clean true \
            --restart true \
            --timeout 600 \
            --verbose
          echo "‚úÖ Package deployed to staging"

      - name: Wait for staging deployment and Oryx build
        run: |
          set -euo pipefail
          echo "‚è≥ Waiting 120 seconds for staging slot Oryx build"
          sleep 120

      - name: Run database migrations on staging slot
        run: |
          set -euo pipefail
          echo "üîÑ Running Alembic migrations on staging slot"
          COMMAND="cd /home/site/wwwroot \
&& (source antenv/bin/activate 2>/dev/null || source .venv/bin/activate 2>/dev/null || (python3 -m venv .venv && source .venv/bin/activate && pip install -r requirements.txt -q)) \
&& python -m alembic upgrade head"

          az webapp deployment run-command invoke \
            --name "$WEBAPP_NAME" \
            --resource-group "$RESOURCE_GROUP" \
            --slot "$STAGING_SLOT" \
            --command "$COMMAND" \
            --query "{status:status,message:message}" -o json

      - name: Verify staging deployment
        run: |
          set -euo pipefail
          echo "üîç Verifying staging deployment"
          chmod +x verify_deployment.sh
          ./verify_deployment.sh "$STAGING_WEBAPP_URL" "${{ secrets.ADMIN_EMPLOYEE_ID }}" "${{ secrets.ADMIN_PASSWORD }}"

      - name: Swap staging slot into production
        run: |
          set -euo pipefail
          echo "üîÅ Swapping staging slot into production"
          az webapp deployment slot swap \
            --name "$WEBAPP_NAME" \
            --resource-group "$RESOURCE_GROUP" \
            --slot "$STAGING_SLOT" \
            --target-slot production
          echo "‚úÖ Swap complete"

      - name: Verify production deployment
        run: |
          set -euo pipefail
          echo "üîç Verifying production deployment"
          ./verify_deployment.sh "$WEBAPP_URL" "${{ secrets.ADMIN_EMPLOYEE_ID }}" "${{ secrets.ADMIN_PASSWORD }}"

      - name: Restart staging slot (post-swap)
        run: |
          set -euo pipefail
          echo "üîÑ Restarting staging slot"
          az webapp restart \
            --name "$WEBAPP_NAME" \
            --resource-group "$RESOURCE_GROUP" \
            --slot "$STAGING_SLOT"

      - name: Deployment summary
        if: always()
        run: |
          echo "\nüöÄ Deployment complete"
          echo "-----------------------"
          echo "Deployment Details:"
          echo "  - Git Commit: ${{ github.sha }}"
          echo "  - Build Number: ${{ github.run_number }}"
          echo "  - Deployed By: ${{ github.actor }}"
          echo ""
          echo "Verification Targets:"
          echo "  - Staging: $STAGING_WEBAPP_URL"
          echo "  - Production: $WEBAPP_URL"
          echo ""
          echo "If login issues persist, reset admin via:"
          echo "curl -X POST $WEBAPP_URL/api/health/reset-admin-password -H 'X-Admin-Secret: <AUTH_SECRET_KEY>'"
